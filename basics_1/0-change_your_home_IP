#!/usr/bin/env bash
# Configure local host resolutions per requirements
# - Set localhost -> 127.0.0.2
# - Set facebook.com -> 8.8.8.8
# Notes:
# - Must be run with root privileges (sudo)
# - Makes a timestamped backup of /etc/hosts before modifying
# - Edits are idempotent: running multiple times keeps desired state

set -euo pipefail

HOSTS_FILE="${HOSTS_FILE:-/etc/hosts}"
STAMP="$(date +%Y%m%d-%H%M%S)"
HOSTS_DIR="$(dirname "$HOSTS_FILE")"
HOSTS_BASE="$(basename "$HOSTS_FILE")"
BACKUP_FILE="${HOSTS_DIR}/${HOSTS_BASE}.bak-${STAMP}"

require_root() {
  # Require root only if we cannot write to the target file or its directory
  if [[ -w "$HOSTS_FILE" || -w "$HOSTS_DIR" ]]; then
    return
  fi
  if [[ ${EUID:-$(id -u)} -ne 0 ]]; then
    echo "This script must be run as root when modifying $HOSTS_FILE. Try: sudo $0" >&2
    exit 1
  fi
}

backup_hosts() {
  cp -p "$HOSTS_FILE" "$BACKUP_FILE"
  echo "Backup created: $BACKUP_FILE"
}

# Ensure localhost resolves to 127.0.0.2 and facebook.com to 8.8.8.8
apply_mappings() {
  # We'll create a temp file and replace atomically to avoid partial writes
  tmpfile="$(mktemp)"

  # Start with our required mappings at the very top to take precedence
  cat >"$tmpfile" <<'EOF'
127.0.0.2	localhost
8.8.8.8	facebook.com
EOF

  # Append existing hosts but filter out any lines that contain these hostnames
  # This avoids duplicates and ensures idempotence even if correct mappings existed
  awk '{
    drop=0;
    for (i=2;i<=NF;i++) {
      if ($i=="localhost" || $i=="facebook.com") { drop=1; break }
    }
    if (!drop) print
  }' "$HOSTS_FILE" >>"$tmpfile"

  # Replace the hosts file atomically
  install -m 644 "$tmpfile" "$HOSTS_FILE"
  rm -f "$tmpfile"
}

main() {
  require_root

  if [[ ! -f "$HOSTS_FILE" ]]; then
    echo "Error: $HOSTS_FILE not found" >&2
    exit 1
  fi

  backup_hosts
  apply_mappings
  echo "Updated $HOSTS_FILE with required mappings."
  echo "- localhost -> 127.0.0.2"
  echo "- facebook.com -> 8.8.8.8"
  echo "Note: To revert, restore from the backup: sudo cp '$BACKUP_FILE' '$HOSTS_FILE'"
}

main "$@"
